# tngl — Project Specification v1.0

> A human-authored, repo-native relational graph tool. An alternative to the README.

---

## Overview

`tngl` is a Rust CLI tool that lets developers create and maintain a living graph of their project — nodes are files and folders, edges are human-defined relationships. It lives inside the repo as a `/tangle` folder, travels with the code, and works over SSH with no browser required.

The graph is not inferred from code dependencies. It is written and maintained by the people who know the project.

---

## Core Concepts

- **Node** — any file or folder in the repo, represented in `graph.tngl`
- **Edge** — a human-authored relationship between two nodes, with a direction and a label
- **Orphan** — a node with no edges; valid and intentional, just explicitly declared
- **The tangle folder** — `/tangle` at the repo root; visible, committed, and shared

---

## The `.tngl` Format

All files use the `.tngl` extension. The format is line-oriented, human-readable, and writable by hand.

### `tangle/graph.tngl`

The primary file. Contains all nodes and edges. Human-authored and hand-editable.

**Syntax:**

```
# This is a comment

src/main.rs
    -> src/auth/        : bootstraps authentication
    -> config.toml      : reads secrets
    -- docs/arch.md     : documented by

src/auth/
    -> src/db/          : queries user table
    -> src/models/      : uses User model

docs/arch.md

README.md
```

**Rules:**
- A node is a bare path on its own line (no leading whitespace)
- Edges are indented beneath their source node (4 spaces or 1 tab)
- `->` is a directed edge (source → target)
- `--` is an undirected edge
- `:` is required after the target path; the label after it is optional but the colon must be present
- A node with no edges beneath it is an explicit orphan — valid and intentional
- Comments begin with `#`
- Blank lines are ignored
- Paths are relative to repo root
- Folder nodes end with `/`

**Edge with no label:**
```
src/main.rs
    -> src/auth/   :
```

**Undirected edge:**
```
src/auth/
    -- docs/auth.md   : documented by
```

---

### `tangle/config.tngl`

Team-shared configuration. Committed to the repo. Generated by `tngl init` with commented defaults. Editable by hand or via `tngl setup` in the TUI.

```
# tngl configuration
# Edit manually or run: tngl setup

# What to do with edges when a file is deleted
# Options: prompt | delete | preserve
on_delete: prompt

# Whether to show orphan nodes in the default TUI view
show_orphans: true

# Auto-update graph.tngl on git operations (requires hook install)
git_hooks: true
```

---

### `.tnglignore`

Lives at the repo root alongside `.gitignore`. Defines additional paths for `tngl update` to skip when scanning the file tree.

```
# .tnglignore
node_modules/
dist/
*.log
coverage/
```

---

## CLI Commands

### `tngl init`

Initialises tngl in the current directory.

- Creates `/tangle/` folder
- Scans the full file tree downward
- Respects `.gitignore` if present
- Creates `.tnglignore` with sensible defaults
- Populates `graph.tngl` with all discovered files and folders as orphan nodes
- Generates `config.tngl` with commented defaults
- Writes a thin `tngl` wrapper shell script to the repo root (for collaborators without global install)
- Optionally installs git hooks (prompts user)

```
$ tngl init
  Scanning file tree...
  Found 42 files and 8 folders
  Created tangle/graph.tngl
  Created tangle/config.tngl
  Created .tnglignore
  Install git hooks? [y/n]
```

---

### `tngl update`

Re-scans the file tree and reconciles against the current `graph.tngl`.

- Walks the entire tree downward from repo root
- Respects `.gitignore` and `.tnglignore`
- **New files** → added as orphan nodes at the bottom of `graph.tngl`
- **Deleted files** → interactive prompt based on `on_delete` config:
  - `prompt` — asks the user for each deleted file with dangling edges
  - `delete` — silently removes the node and all its edges
  - `preserve` — leaves the node and edges, marks node as `# [missing]`
- Never modifies hand-authored edges unless a referenced node is deleted
- Fast — derives current state by walking filesystem and parsing `graph.tngl` directly; no external state file

```
$ tngl update
  Scanning...
  3 new files added as orphan nodes
  1 deleted file with 2 dangling edges:
    src/old_auth.ts (deleted)
      -> src/db/   : queries
      -> config.toml   : reads

  What should happen to these edges?
  [d] delete  [p] preserve  [s] skip for now
```

---

### `tngl status`

Diffs the current filesystem against `graph.tngl`. Fast, read-only, no changes made.

- Walks the file tree
- Reports files present in filesystem but not in `graph.tngl` (untracked)
- Reports files in `graph.tngl` but missing from filesystem (deleted/missing)
- Reports edges pointing to missing nodes (dangling)
- Reports nodes with no edges (orphans) — informational, not an error

```
$ tngl status

  Untracked files (not in graph):
    src/new_feature.rs
    tests/new_test.rs

  Missing files (in graph, not on disk):
    src/old_auth.ts  [2 dangling edges]

  Orphan nodes (no connections):
    docs/roadmap.md
    scripts/build.sh

  Graph is otherwise clean.
```

---

### `tngl inspect`

Queries the graph for specific conditions. Useful for auditing and exploring.

```
tngl inspect --orphans          # list all nodes with no edges
tngl inspect --dangling         # list edges pointing to missing files
tngl inspect --edges src/auth/  # show all edges for a specific node
tngl inspect --unreachable      # nodes not reachable from any other node
```

---

### `tngl view`

Opens the interactive TUI canvas. Primary interface for navigating and editing the graph.

See TUI section below.

---

### `tngl open`

Generates a self-contained `tangle/graph.html` file and opens it in the default browser. Read-only. No server. The HTML file is self-contained and can be committed or shared.

```
$ tngl open
  Generated tangle/graph.html
  Opening in browser...
```

---

### `tngl setup`

Opens the TUI settings panel directly. Equivalent to pressing the settings key inside `tngl view`. Edits `config.tngl`.

---

## TUI — Interactive Canvas

The TUI is the primary editing interface. It must be fully functional over SSH. Built in Rust using **Ratatui**.

### Layout

```
┌─────────────────────────────────────────────────────┐
│ tngl — myproject              [?] help  [q] quit    │
├─────────────────────────────────────────────────────┤
│                                                     │
│    [src/main.rs] ──────────► [src/auth/]            │
│         │                        │                  │
│         └──────────────────► [config.toml]          │
│                                                     │
│    [docs/arch.md]                                   │
│                                                     │
│                                                     │
├─────────────────────────────────────────────────────┤
│ SELECTED: src/auth/   edges: 3   label: —           │
│ [e] edit  [n] new edge  [d] delete  [o] orphans     │
└─────────────────────────────────────────────────────┘
```

### Navigation

| Key | Action |
|-----|--------|
| Arrow keys | Move focus between nodes |
| `Enter` | Select/activate node |
| `Tab` | Cycle through nodes in order |
| `h/j/k/l` | Vim-style node navigation |
| `+` / `-` | Zoom in / out |
| `Space` | Pan canvas |
| `q` | Quit |
| `?` | Help overlay |

### Node Operations

| Key | Action |
|-----|--------|
| `n` | Add a new manual node |
| `e` | Edit selected node's label/note |
| `D` | Delete selected node (prompts if has edges) |
| `o` | Toggle orphan visibility |

### Edge Operations

| Key | Action |
|-----|--------|
| `c` | Connect — start drawing an edge from selected node |
| `x` | Detach — pick up an edge end and reconnect to a new node |
| `d` | Delete selected edge |
| `l` | Edit edge label |
| `t` | Toggle edge direction (directed ↔ undirected) |
| `r` | Reverse edge direction |

**Connecting nodes flow:**
1. Select source node, press `c`
2. Status bar prompts: "Select target node..."
3. Navigate to target node with arrow keys, press `Enter`
4. Prompt: "Label (leave blank for none):" → type label → `Enter`
5. Edge is created and written to `graph.tngl`

**Detaching an edge flow:**
1. Select a node, press `x`
2. Choose which edge to detach from list
3. Choose which end to detach (source or target)
4. Navigate to new node, press `Enter`
5. Edge is rewritten in `graph.tngl`

### Settings Panel (`tngl setup`)

- `on_delete` — prompt / delete / preserve
- `show_orphans` — toggle
- `git_hooks` — install / uninstall

All changes write directly to `tangle/config.tngl`.

---

## Git Integration

### Wrapper Script

`tngl init` writes a small shell script `./tngl` to the repo root:

```sh
#!/bin/sh
# tngl wrapper — https://github.com/yourname/tngl
if command -v tngl >/dev/null 2>&1; then
  tngl "$@"
else
  echo "tngl is not installed."
  echo "Install it with: cargo install tngl"
  echo "Or visit: https://github.com/yourname/tngl"
  exit 1
fi
```

This means contributors can run `./tngl view` and get a helpful message if not installed.

### Git Hooks (optional, opt-in)

If the user accepts during `tngl init` or enables in config:

```
.git/hooks/post-merge    → runs tngl update --silent
.git/hooks/post-checkout → runs tngl update --silent
```

`--silent` suppresses output unless there are conflicts requiring user input.

## File Tree Scanning Rules

In priority order:

1. Always ignore `.git/`
2. Respect `.gitignore` if present in repo root
3. Respect `.tnglignore` if present in repo root
4. Do not recurse into ignored directories
5. Include all remaining files and folders as nodes
6. Folder nodes always end with `/` in `graph.tngl`

---

## Project Structure (Rust)

```
tngl/
  src/
    main.rs          # CLI entrypoint, command routing
    commands/
      init.rs
      update.rs
      status.rs
      inspect.rs
      view.rs
      open.rs
    parser/
      graph.rs       # .tngl format parser and writer
      config.rs      # config.tngl parser
    scanner/
      tree.rs        # filesystem walker, gitignore/tnglignore handling
      diff.rs        # diff filesystem vs graph.tngl
    tui/
      canvas.rs      # main TUI canvas (Ratatui)
      input.rs       # keyboard event handling
      render.rs      # node/edge rendering
      settings.rs    # settings panel
    graph/
      model.rs       # Node, Edge, Graph structs
  Cargo.toml
```

---

## Dependencies (Rust Crates)

| Crate | Purpose |
|-------|---------|
| `clap` | CLI argument parsing |
| `ratatui` | TUI framework |
| `crossterm` | Cross-platform terminal input/output |
| `ignore` | Gitignore-aware file tree walking (same as ripgrep) |
| `serde` / `serde_json` | Serialisation for layout/config |
| `anyhow` | Error handling |
| `walkdir` | Filesystem traversal fallback |

---

## V1 Scope

V1 is a fully working local tool. No packaging or distribution yet.

**In scope:**
- `tngl init`
- `tngl update` with interactive conflict resolution
- `tngl status`
- `tngl inspect` with `--orphans`, `--dangling`, `--edges <node>`
- `tngl view` — full TUI canvas with node navigation and edge editing
- `tngl open` — static HTML export
- `tngl setup` — settings via TUI
- `.tngl` format parser and writer (round-trip safe — hand edits preserved)
- `.tnglignore` support
- `.gitignore` respect
- Git hooks (opt-in)
- Wrapper shell script

**Out of scope (V2):**
- Binary releases (Homebrew, cargo-binstall, GitHub releases)
- Windows `.bat` wrapper
- Package registry publishing
- CI/CD integration docs
- Plugin or extension system

---

## V2 Scope

V2 is about making tngl installable and discoverable by anyone.

- Cross-platform binary builds (Linux x86_64, macOS arm64/x86_64, Windows)
- Homebrew formula
- `cargo install tngl` on crates.io
- GitHub Releases with pre-built binaries
- Windows wrapper script (`.bat`)
- README and documentation site
- `tngl open` HTML polish pass

---

## Key Design Constraints

- **No runtime dependency** — single static binary
- **Format is the source of truth** — `graph.tngl` is always human-readable and hand-editable; tooling never corrupts hand edits
- **Round-trip safe parser** — parsing then re-serialising `graph.tngl` must produce identical output (preserving comments, blank lines, ordering)
- **Fast** — `tngl status` and `tngl update` walk the filesystem directly; no daemon, no background process, no external state file
- **SSH-first** — every feature works in a plain terminal; browser is a bonus
- **Git-compatible** — all files in `/tangle` are plain text, diff cleanly, merge without special tooling

---

## Example Repo After `tngl init`

```
myproject/
  tangle/
    graph.tngl
    config.tngl
  .tnglignore
  tngl              ← wrapper script
  src/
  docs/
  README.md
```
